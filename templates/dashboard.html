{% extends "base.html" %}

{% block title %}Dashboard - Chat Inbox{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>Chat Inbox</h1>
    <p class="subtitle">Select chats to analyze</p>

    <!-- Date Range Filter -->
    <div class="filter-section">
        <h3>Filter by Date</h3>
        <div class="filter-controls">
            <select id="date-preset" onchange="app.applyPreset()">
                <option value="24">Last 24 hours</option>
                <option value="48">Last 48 hours</option>
                <option value="168">Last week</option>
                <option value="720">Last month</option>
                <option value="custom">Custom range</option>
            </select>

            <div id="custom-dates" style="display: none;">
                <input type="datetime-local" id="start-date" placeholder="Start">
                <input type="datetime-local" id="end-date" placeholder="End">
            </div>

            <button class="btn btn-primary" onclick="app.loadChats()">Apply Filter</button>
            <span id="filter-info" class="filter-info"></span>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading chats...</p>
    </div>

    <!-- Chat List -->
    <div class="chat-list" id="chat-list">
        <p class="empty-state">No chats loaded. Click "Apply Filter" to fetch chats.</p>
    </div>

    <!-- Analysis Result Panel -->
    <div class="analysis-panel" id="analysis-panel" style="display: none;">
        <h2>Analysis Result</h2>
        <div class="analysis-header">
            <h3 id="analysis-title"></h3>
            <button class="btn btn-close" onclick="app.closeAnalysis()">X</button>
        </div>
        <div class="analysis-meta">
            <span id="analysis-confidence"></span>
            <span id="analysis-date"></span>
        </div>
        <div class="analysis-content" id="analysis-content"></div>
        <div class="analysis-footer">
            <button class="btn btn-secondary" onclick="app.closeAnalysis()">Close</button>
        </div>
    </div>

    <!-- Knowledge Base Modal -->
    <div class="modal" id="knowledge-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Knowledge Base Manager</h2>
                <button class="btn btn-close" onclick="app.closeKnowledgeModal()">X</button>
            </div>
            <div class="modal-body">
                <label>File Type:</label>
                <select id="kb-file-type" onchange="app.loadKnowledgeBase(this.value)">
                    <option value="prices">Prices (business_data.txt)</option>
                    <option value="instructions">Instructions (instructions.txt)</option>
                </select>
                <label>Content:</label>
                <textarea id="kb-content" rows="12" placeholder="File content..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeKnowledgeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveKnowledgeBase()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Knowledge Base Button to Filter Section -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterSection = document.querySelector('.filter-controls');
            if (filterSection) {
                const kb_btn = document.createElement('button');
                kb_btn.className = 'btn btn-secondary';
                kb_btn.textContent = 'Knowledge Base';
                kb_btn.onclick = function() {
                    const modal = document.getElementById('knowledge-modal');
                    if (modal) {
                        modal.classList.add('active');
                        app.loadKnowledgeBase('prices');
                    }
                };
                filterSection.appendChild(kb_btn);
            }
        });
    </script>
</div>

<script src="{{ url_for('web.static', filename='js/app.js') }}"></script>
<script>
    // Initialize app on page load
    window.addEventListener('DOMContentLoaded', function() {
        app.init();
    });
</script>
{% endblock %}
