{% extends "base.html" %}

{% block title %}Dashboard - Chat Inbox{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Header -->
    <div>
        <h1>Chat Inbox Dashboard</h1>
        <p class="subtitle">AI-Powered Chat Analysis & Management</p>
    </div>

    <!-- General Stats Card -->
    <div class="stats-card" id="stats-card">
        <div class="stat-item">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-wins">0</div>
            <div class="stat-label">Wins</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-losses">0</div>
            <div class="stat-label">Losses</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-revenue">$0</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-confidence">0%</div>
            <div class="stat-label">Avg Confidence</div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <h3>Filter by Date</h3>
        <div class="filter-controls">
            <select id="date-preset" onchange="app.applyPreset()">
                <option value="24">Last 24 hours</option>
                <option value="48">Last 48 hours</option>
                <option value="168">Last week</option>
                <option value="720">Last month</option>
                <option value="custom">Custom range</option>
            </select>

            <div id="custom-dates" style="display: none;">
                <input type="datetime-local" id="start-date" placeholder="Start">
                <input type="datetime-local" id="end-date" placeholder="End">
            </div>

            <button class="btn btn-primary" id="apply-btn" onclick="app.loadChats()">
                <span>Apply Filter</span>
            </button>
            <button class="btn btn-secondary" id="refresh-btn" onclick="app.loadChats()" title="Reload chat list">
                <span>Refresh</span>
            </button>
            <span id="filter-info" class="filter-info"></span>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Main Content Grid: Chat List (Left) + Analysis Panel (Right) -->
    <div class="content-grid">
        <!-- Left Panel: Chat List -->
        <div class="chat-panel">
            <div class="chat-panel-header">ðŸ“± Available Chats</div>
            <div class="chat-list" id="chat-list">
                <p class="empty-state">No chats loaded. Click "Apply Filter" to fetch chats.</p>
            </div>
        </div>

        <!-- Right Panel: Analysis -->
        <div class="analysis-panel" id="analysis-panel">
            <h2>Analysis</h2>
            <div id="analysis-content" class="analysis-empty">
                <p>Select a chat and click "Analyze" to view results here</p>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Modal -->
    <div class="modal" id="knowledge-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Knowledge Base Manager</h2>
                <button class="btn btn-close" onclick="app.closeKnowledgeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <label>File Type:</label>
                <select id="kb-file-type" onchange="app.loadKnowledgeBase(this.value)">
                    <option value="prices">Prices (business_data.txt)</option>
                    <option value="instructions">Instructions (instructions.txt)</option>
                </select>
                <label>Content:</label>
                <textarea id="kb-content" rows="12" placeholder="File content..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeKnowledgeModal()">Cancel</button>
                <button class="btn btn-primary" id="kb-save-btn" onclick="app.saveKnowledgeBase()">
                    <span>Save</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('web.static', filename='js/app.js') }}"></script>
<script>
    // Initialize app on page load
    window.addEventListener('DOMContentLoaded', function() {
        app.init();
        // Load general stats on page load
        app.loadGeneralStats();
        // Load chats on page load
        app.loadChats();
        // Add knowledge base button to filter section
        app.addKnowledgeBaseButton();
    });
</script>
{% endblock %}
